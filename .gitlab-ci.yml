image: tmaier/docker-compose:latest

variables:
    LANG: C.UTF-8
    LC_ALL: C.UTF-8
    COMPOSE: docker-compose -f docker-compose.yml -f docker-compose.ci.yml
    APPLICATION: demo

before_script:
    - mkdir /root/.docker
    - echo "$RUNNER_DOCKER_CAPEM" > /root/.docker/ca.pem
    - echo "$RUNNER_DOCKER_CERTPEM" > /root/.docker/cert.pem
    - echo "$RUNNER_DOCKER_KEYPEM" > /root/.docker/key.pem

stages:
    - test
    - build
    - deploy

test:
    stage: test
    services:
        - docker:dind
    script:
        # pull docker images for cache
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN acr.run
        # need to run pulling of images in subshell as otherwise CI_COMMIT_REF_SLUG
        # is set for following commands as well
        - sh -c "export CI_COMMIT_REF_SLUG=master; eval $COMPOSE pull --ignore-pull-failures ember django db"
        # start only services which are needed for testing
        - eval $COMPOSE up -d --build db keycloak clamav unoconv
        # build images needed for testing
        - eval $COMPOSE build --pull ember django
        # run django tests
        - eval $COMPOSE run --rm --no-deps django make install-dev test
        # run ember tests
        - eval $COMPOSE run --rm --no-deps ember yarn test

build:
    stage: build
    services:
        - docker:dind
    script:
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN acr.run
        - eval $COMPOSE pull --ignore-pull-failures ember django php db
        - eval $COMPOSE build --pull
        - eval $COMPOSE push
    only:
        - master


build-kt_schwyz-stage:
    stage: build
    services:
        - docker:dind
    variables:
        KEYCLOAK_URL: https://login.ebau.sz.testyard.ch/auth/
        APPLICATION: kt_schwyz
        COMPOSE: docker-compose -f docker-compose.yml -f docker-compose.production.yml
    script:
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN acr.run
        - eval $COMPOSE pull --ignore-pull-failures ember django php db
        - eval $COMPOSE build --pull
        - eval $COMPOSE push
    only:
        - stage


build-kt_uri-stage:
    stage: build
    services:
        - docker:dind
    variables:
        APPLICATION: kt_uri
        COMPOSE: docker-compose -f docker-compose.yml -f docker-compose.production.yml
    script:
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN acr.run
        - eval $COMPOSE pull --ignore-pull-failures ember django php db
        - eval $COMPOSE build --pull
        - eval $COMPOSE push
    only:
        - stage


build-kt_uri-production:
    stage: build
    services:
        - docker:dind
    variables:
        APPLICATION: kt_uri
        COMPOSE: docker-compose -f docker-compose.yml -f docker-compose.production.yml
    script:
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN acr.run
        - eval $COMPOSE pull --ignore-pull-failures ember django php db
        - eval $COMPOSE build --pull
        - eval $COMPOSE push
    only:
        - production


deploy-kt_schwyz-stage:
    environment:
        name: stage-kt_schwyz
        url: https://camac-schwyz.sycloud.ch/
    variables:
        APPLICATION: kt_schwyz
        # because of https://github.com/docker/compose/issues/2668 tls certs
        # need to be assigned as parameters - once fixed such params can be removed.
        COMPOSE: docker-compose -f docker-compose.yml -f docker-compose.production.yml --tlsverify --tlscert /root/.docker/cert.pem --tlskey /root/.docker/key.pem --tlscacert /root/.docker/ca.pem
        DOCKER_HOST: vm-camac-webapp-stage-02.cust.adfinis-sygroup.ch:2376
        DOCKER_TLS_VERIFY: 1
    stage: deploy
    script:
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN acr.run
        - eval $COMPOSE pull
        - eval $COMPOSE up -d
    only:
        - stage

pyup:
    stage: test
    image: python:3.6
    variables:
        PIP_CACHE_DIR: "pip-cache"
    cache:
        paths:
            - "pip-cache"
    script:
        # Pin to python-gitlab 1.2.0 as 1.3.0 is failing
        # has something to do with url encoding but not clear whether issue is
        # our configuration (Apache...) or in gitlab itself
        # TODO test again when we use GitLab with nginx
        - pip install -U python-gitlab==1.2.0 pyupio
        - pyup --provider gitlab --repo=819 --user-token=$GITTY_USER_TOKEN@https://git.adfinis-sygroup.ch/
    only:
        - disabled
