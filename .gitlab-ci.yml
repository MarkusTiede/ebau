image: docker:vcamac-dind

before_script:
    - pip install docker-compose
    - docker-compose -f docker/gitlab-ci-compose.yml up -d

after_script:
    - docker-compose -f docker/gitlab-ci-compose.yml stop
 
stages:
    - test

run-test:
    stage: test
    script:
        - ls -al
        - docker run -i --rm --name config-import -v "$PWD"/:/usr/src/camac -e 'USE_DB=docker_dev' --link docker_camac_db_1:camac_db  -w=/usr/src/camac/ adsy/camac_python_oracle:v8 ls -lah /usr/src/camac
        - docker run -i --rm --name config-import -v "$PWD"/:/usr/src/camac -e 'USE_DB=docker_dev' --link docker_camac_db_1:camac_db  -w=/usr/src/camac/ adsy/camac_python_oracle:v8 python .wait-for-oracle-db.py camac_db 1521 
        - make _init-ci
        - make db-init
        - make config-import-ci
        - make run-acceptance-tests-ci
        - docker-compose stop

variables:
  LANG: C.UTF-8
  LC_ALL: C.UTF-8
