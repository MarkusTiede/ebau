before_script:
    - source /etc/profile
    - source /opt/xvfb.sh
    - pip install -r db_admin/requirements.txt

services:
    - memcached
    - wnameless/oracle-xe-11g

stages:
    - test

run-test:
    stage: test
    script:
        - echo "Starting the build"
        - date
        - bash -c "[ -d /builds/kantonur/camac5.src ] || ln -s $(dirname $CI_PROJECT_DIR) /builds/kantonur"
        - source /etc/apache2/envvars
        - make _ci-init
        - bash .wait-for-ssh.sh wnameless__oracle-xe-11g 22
        - python .wait-for-oracle-db.py wnameless__oracle-xe-11g 1521
        - ssh-keyscan -H wnameless__oracle-xe-11g >> ~/.ssh/known_hosts
        - echo "Initialising DB"
        - date
        - make db-init DB_CONTAINER_HOSTNAME=wnameless__oracle-xe-11g DB_CONTAINER_PORT=22
        - echo "Importing config"
        - date
        - make ci-config-import
        - echo "Running Tests"
        - date
        - make ci-run-acceptance-tests

variables:
    LANG: C.UTF-8
    LC_ALL: C.UTF-8
    ORACLE_HOME: /usr/local/lib/instantclient_11_2
    LD_LIBRARY_PATH: /usr/local/lib/instantclient_11_2

