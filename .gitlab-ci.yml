image: tmaier/docker-compose:latest
services:
    - docker:dind

variables:
    LANG: C.UTF-8
    LC_ALL: C.UTF-8

stages:
    - test

test:
    stage: test
    script:
        - docker-compose up -d --force-recreate
        # docker exec workaround till following error is fixed:
        # https://github.com/docker/compose/issues/3352
        # - docker-compose exec camac-django make install-dev test
        # - docker-compose exec camac-ember yarn test
        - docker exec -i $(docker-compose ps -q camac-django) make install-dev test
        - docker exec -i $(docker-compose ps -q camac-ember) yarn test

pyup:
    stage: test
    image: python:3.6
    script:
        - pip install pyupio
        - pyup --provider gitlab --repo=819 --user-token=$GITTY_USER_TOKEN@https://git.adfinis-sygroup.ch/
    only:
        - master
