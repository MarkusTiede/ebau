image: tmaier/docker-compose:latest
services:
    - docker:dind

variables:
    LANG: C.UTF-8
    LC_ALL: C.UTF-8
    COMPOSE: docker-compose -f docker-compose.yml -f docker-compose.ci.yml

stages:
    - test
    - build

test:
    stage: test
    script:
        # pull docker images for cache
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN acr.run
        - CI_COMMIT_REF_SLUG=master eval $COMPOSE pull --parallel ember django
        - eval $COMPOSE build --pull ember django
        # start only services which are needed for testing
        - eval $COMPOSE up -d db
        # run django tests
        - eval $COMPOSE run --rm --no-deps django make install-dev test
        # run ember tests
        - eval $COMPOSE run --rm --no-deps ember yarn test

build:
    stage: build
    script:
        - docker login -u gitlab-ci-token -p $CI_JOB_TOKEN acr.run
        - eval $COMPOSE pull --parallel ember django php
        - eval $COMPOSE build --pull
        - eval $COMPOSE push
    only:
        - master

pyup:
    stage: test
    image: python:3.6
    script:
        - pip install pyupio
        - pyup --provider gitlab --repo=819 --user-token=$GITTY_USER_TOKEN@https://git.adfinis-sygroup.ch/
    only:
        - master
